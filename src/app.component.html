<div class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-purple-50 relative overflow-hidden">

  <!-- Ad Overlay -->
  @if (adVisible()) {
    <div class="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center text-white p-8">
      <div class="animate-bounce text-6xl mb-8">üì∫</div>
      <h2 class="text-3xl font-bold mb-4 comic-font">ADVERTISEMENT</h2>
      <p class="text-lg mb-8">This app is free thanks to ads!</p>
      
      <div class="w-full max-w-md bg-white/20 h-4 rounded-full mb-8 overflow-hidden">
        <div class="h-full bg-green-500 transition-all duration-1000 ease-linear" 
             [style.width.%]="(adTimer() / (adReward() > 10 ? 15 : 5)) * 100">
        </div>
      </div>
      
      <div class="text-2xl font-mono">{{ adTimer() }}s remaining</div>
      
      @if (adTimer() === 0) {
        <button (click)="completeAd()" class="mt-8 px-8 py-3 bg-green-600 rounded-full hover:bg-green-500 font-bold">
          Collect {{ adReward() }} Coins & Close
        </button>
      }
    </div>
  }

  <!-- Milestones Overlay -->
  @if (showMilestones()) {
     <div class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
          <div class="bg-indigo-500 p-4 flex justify-between items-center text-white">
            <h2 class="text-2xl font-bold comic-font">üèÜ Milestones</h2>
            <button (click)="toggleMilestones()" class="text-2xl hover:bg-white/20 w-10 h-10 rounded-full">‚úï</button>
          </div>
          <div class="p-6 overflow-y-auto flex-1 bg-indigo-50">
             <div class="grid grid-cols-1 gap-4">
                @for (m of milestones(); track m.id) {
                   <div class="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm border-2"
                        [class.border-gray-200]="!m.unlocked"
                        [class.border-yellow-400]="m.unlocked"
                        [class.opacity-60]="!m.unlocked">
                      <div class="text-4xl filter" [class.grayscale]="!m.unlocked">{{ m.icon }}</div>
                      <div>
                         <h3 class="font-bold text-gray-800">{{ m.title }}</h3>
                         <p class="text-sm text-gray-600">{{ m.description }}</p>
                         @if (m.unlocked) {
                            <span class="text-xs font-bold text-green-600 uppercase tracking-wider">Unlocked!</span>
                         } @else {
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Locked</span>
                         }
                      </div>
                   </div>
                }
             </div>
          </div>
        </div>
     </div>
  }

  <!-- Games Overlay -->
  @if (showGames()) {
     <div class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col">
          <div class="bg-green-500 p-4 flex justify-between items-center text-white">
            <h2 class="text-2xl font-bold comic-font">üéÆ Learning Games</h2>
            <button (click)="toggleGames()" class="text-2xl hover:bg-white/20 w-10 h-10 rounded-full">‚úï</button>
          </div>
          <div class="p-6 bg-green-50 grid grid-cols-1 gap-4">
             <button (click)="triggerGame('Colors')" class="bg-white p-4 rounded-xl border-2 border-green-200 hover:bg-green-50 flex items-center gap-4">
               <span class="text-4xl">üé®</span>
               <div class="text-left">
                 <h3 class="font-bold text-lg">Colors</h3>
                 <p class="text-sm text-gray-600">Identify items by color.</p>
               </div>
             </button>
             <button (click)="triggerGame('Shapes')" class="bg-white p-4 rounded-xl border-2 border-blue-200 hover:bg-blue-50 flex items-center gap-4">
               <span class="text-4xl">üî∫</span>
               <div class="text-left">
                 <h3 class="font-bold text-lg">Shapes</h3>
                 <p class="text-sm text-gray-600">Find the circles and squares!</p>
               </div>
             </button>
             <button (click)="triggerGame('Counting')" class="bg-white p-4 rounded-xl border-2 border-yellow-200 hover:bg-yellow-50 flex items-center gap-4">
               <span class="text-4xl">1Ô∏è‚É£</span>
               <div class="text-left">
                 <h3 class="font-bold text-lg">Counting</h3>
                 <p class="text-sm text-gray-600">Let's count to 5!</p>
               </div>
             </button>
          </div>
        </div>
     </div>
  }

  <!-- Store Overlay -->
  @if (showStore()) {
    <div class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
        <div class="bg-orange-400 p-4 flex justify-between items-center text-white">
          <h2 class="text-2xl font-bold comic-font">üõçÔ∏è Baby Store</h2>
          <button (click)="toggleStore()" class="text-2xl hover:bg-white/20 w-10 h-10 rounded-full">‚úï</button>
        </div>
        
        <!-- Store Content -->
        <div class="p-6 overflow-y-auto flex-1 bg-orange-50">
          
          <!-- Ad Button -->
          <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-4 text-white flex items-center justify-between mb-6 shadow-lg transform hover:scale-[1.02] transition-transform cursor-pointer"
               (click)="triggerAd('rewarded')">
             <div>
               <h3 class="font-bold text-lg">Watch Video Ad</h3>
               <p class="text-xs opacity-80">Earn 15-20 Coins!</p>
             </div>
             <div class="text-3xl">üé¨üí∞</div>
          </div>

          <h3 class="font-bold text-gray-700 mb-3 ml-1">üçé Food & Treats</h3>
          <div class="grid grid-cols-3 gap-3 mb-6">
            @for (item of storeItems; track item.id) {
              @if (item.type === 'food') {
                <button (click)="buyItem(item)" 
                  class="bg-white p-2 rounded-xl border-2 border-orange-100 hover:border-orange-300 shadow-sm flex flex-col items-center gap-1 transition-all hover:shadow-md h-full justify-between">
                  <div class="text-3xl">{{ item.icon }}</div>
                  <div class="font-bold text-gray-800 text-xs leading-tight">{{ item.name }}</div>
                  <div class="text-orange-500 font-bold text-xs">{{ item.price }} üí∞</div>
                </button>
              }
            }
          </div>

          <h3 class="font-bold text-gray-700 mb-3 ml-1">üëï Clothes & Gear</h3>
          <div class="grid grid-cols-3 gap-3 mb-6">
            @for (item of storeItems; track item.id) {
              @if (item.type === 'clothing') {
                <button (click)="buyItem(item)" 
                  [class.opacity-50]="isOwned(item.id)"
                  class="bg-white p-2 rounded-xl border-2 border-blue-100 hover:border-blue-300 shadow-sm flex flex-col items-center gap-1 transition-all hover:shadow-md h-full justify-between">
                  <div class="text-3xl">{{ item.icon }}</div>
                  <div class="font-bold text-gray-800 text-xs leading-tight">{{ item.name }}</div>
                  <div class="text-blue-500 font-bold text-xs">{{ isOwned(item.id) ? 'Owned' : item.price + ' üí∞' }}</div>
                </button>
              }
            }
          </div>

          <h3 class="font-bold text-gray-700 mb-3 ml-1">üß∏ Toys</h3>
          <div class="grid grid-cols-3 gap-3">
             @for (item of storeItems; track item.id) {
              @if (item.type === 'toy') {
                <button (click)="buyItem(item)" 
                   [class.opacity-50]="isOwned(item.id)"
                   class="bg-white p-2 rounded-xl border-2 border-pink-100 hover:border-pink-300 shadow-sm flex flex-col items-center gap-1 transition-all hover:shadow-md h-full justify-between">
                  <div class="text-3xl">{{ item.icon }}</div>
                  <div class="font-bold text-gray-800 text-xs leading-tight">{{ item.name }}</div>
                  <div class="text-pink-500 font-bold text-xs">{{ isOwned(item.id) ? 'Owned' : item.price + ' üí∞' }}</div>
                </button>
              }
            }
          </div>

        </div>
      </div>
    </div>
  }

  <!-- Header -->
  <header class="w-full max-w-md flex flex-col gap-2 mb-4">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-indigo-600 comic-font tracking-wide">Toddler Talk üçº</h1>
        
        <!-- Coins & Reset -->
        <div class="flex items-center gap-3">
            <div class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full font-bold flex items-center gap-1 shadow-sm border border-yellow-500">
                <span>üí∞</span> {{ coins() }}
            </div>
            @if (stage() === 'chat') {
                <button (click)="resetApp()" class="text-xs text-gray-500 hover:text-red-500 underline">
                    Reset
                </button>
            }
        </div>
    </div>
  </header>

  <!-- Setup Stage 1: Choose Parent -->
  @if (stage() === 'setup-parent') {
    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 text-center animate-bounce-slow max-h-[85vh] overflow-y-auto">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 comic-font">Customize Parents</h2>
      
      <!-- Momma Customizer -->
      <div class="mb-6 p-4 bg-pink-50 rounded-2xl border border-pink-100">
        <div class="text-4xl mb-2">üë©</div>
        <h3 class="font-bold text-pink-700 mb-2">Momma</h3>
        <div class="grid grid-cols-2 gap-2 text-xs text-left">
           <div>
             <label class="block text-gray-500">Race</label>
             <p class="font-bold truncate">{{ momProfile().raceLabel }}</p>
           </div>
           <div>
             <label class="block text-gray-500">Body</label>
             <p class="font-bold truncate">{{ momProfile().bodyType }}</p>
           </div>
           
           <div class="col-span-2">
             <label class="block text-gray-500">Hair Color</label>
             <select [(ngModel)]="momProfile().hairColor" class="w-full p-1 rounded border border-pink-200">
                @for (c of hairColors; track c) { <option [value]="c">{{c}}</option> }
             </select>
           </div>
           <div class="col-span-2">
             <label class="block text-gray-500">Hair Style</label>
             <select [(ngModel)]="momProfile().hairStyle" class="w-full p-1 rounded border border-pink-200">
                @for (s of hairStyles; track s) { <option [value]="s">{{s}}</option> }
             </select>
           </div>
           
           <div class="col-span-2">
             <label class="block text-gray-500">Eye Color</label>
             <select [(ngModel)]="momProfile().eyeColor" class="w-full p-1 rounded border border-pink-200">
                @for (c of eyeColors; track c) { <option [value]="c">{{c}}</option> }
             </select>
           </div>

           <div class="col-span-2">
             <label class="block text-gray-500">Facial Feature</label>
             <select [(ngModel)]="momProfile().facialFeatures" class="w-full p-1 rounded border border-pink-200">
                @for (f of facialFeatureOptions; track f) { <option [value]="f">{{f}}</option> }
             </select>
           </div>
           
           <div class="col-span-2">
             <label class="block text-gray-500">Style</label>
             <select [(ngModel)]="momProfile().clothingStyle" class="w-full p-1 rounded border border-pink-200">
                @for (s of clothingStyles; track s) { <option [value]="s">{{s}}</option> }
             </select>
           </div>
        </div>
        <button (click)="selectParent('Momma')" class="mt-4 w-full py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600">Play as Momma</button>
      </div>

      <!-- Dada Customizer -->
      <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
        <div class="text-4xl mb-2">üë®</div>
        <h3 class="font-bold text-blue-700 mb-2">Dada</h3>
        <div class="grid grid-cols-2 gap-2 text-xs text-left">
           <div>
             <label class="block text-gray-500">Race</label>
             <p class="font-bold truncate">{{ dadProfile().raceLabel }}</p>
           </div>
           <div>
             <label class="block text-gray-500">Body</label>
             <p class="font-bold truncate">{{ dadProfile().bodyType }}</p>
           </div>
           
           <div class="col-span-2">
             <label class="block text-gray-500">Hair Color</label>
             <select [(ngModel)]="dadProfile().hairColor" class="w-full p-1 rounded border border-blue-200">
                @for (c of hairColors; track c) { <option [value]="c">{{c}}</option> }
             </select>
           </div>
           <div class="col-span-2">
             <label class="block text-gray-500">Hair Style</label>
             <select [(ngModel)]="dadProfile().hairStyle" class="w-full p-1 rounded border border-blue-200">
                @for (s of hairStyles; track s) { <option [value]="s">{{s}}</option> }
             </select>
           </div>

           <div class="col-span-2">
             <label class="block text-gray-500">Eye Color</label>
             <select [(ngModel)]="dadProfile().eyeColor" class="w-full p-1 rounded border border-blue-200">
                @for (c of eyeColors; track c) { <option [value]="c">{{c}}</option> }
             </select>
           </div>

           <div class="col-span-2">
             <label class="block text-gray-500">Facial Feature</label>
             <select [(ngModel)]="dadProfile().facialFeatures" class="w-full p-1 rounded border border-blue-200">
                @for (f of facialFeatureOptions; track f) { <option [value]="f">{{f}}</option> }
             </select>
           </div>

           <div class="col-span-2">
             <label class="block text-gray-500">Style</label>
             <select [(ngModel)]="dadProfile().clothingStyle" class="w-full p-1 rounded border border-blue-200">
                @for (s of clothingStyles; track s) { <option [value]="s">{{s}}</option> }
             </select>
           </div>
        </div>
        <button (click)="selectParent('Dada')" class="mt-4 w-full py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600">Play as Dada</button>
      </div>

      <p class="text-xs text-gray-400 mt-4 italic">Core genetics are randomized on reset!</p>
    </div>
  }

  <!-- Setup Stage 2: Choose Child -->
  @if (stage() === 'setup-child') {
    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 text-center">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 comic-font">Who do you want to play with?</h2>
      
      <div class="flex flex-col gap-4">
        <!-- Billy -->
        <button (click)="selectChild('Billy')" 
          class="w-full p-4 rounded-2xl bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 hover:border-blue-400 flex items-center gap-4 transition-all text-left">
          <div class="w-16 h-16 rounded-full bg-blue-200 flex items-center justify-center text-3xl shadow-inner">
            üë¶
          </div>
          <div>
            <h3 class="font-bold text-blue-900 text-lg">Biwwy (Billy)</h3>
            <p class="text-sm text-blue-600">Active, loud, loves trucks!</p>
          </div>
        </button>

        <!-- Sarah -->
        <button (click)="selectChild('Sarah')" 
          class="w-full p-4 rounded-2xl bg-pink-50 hover:bg-pink-100 border-2 border-pink-200 hover:border-pink-400 flex items-center gap-4 transition-all text-left">
          <div class="w-16 h-16 rounded-full bg-pink-200 flex items-center justify-center text-3xl shadow-inner">
            üëß
          </div>
          <div>
            <h3 class="font-bold text-pink-900 text-lg">Thawa (Sarah)</h3>
            <p class="text-sm text-pink-600">Sweet, bossy, loves dolls!</p>
          </div>
        </button>

        <!-- Both -->
        <button 
          (click)="canUnlockBoth() ? selectChild('Both') : null" 
          [class.opacity-60]="!canUnlockBoth()"
          [class.cursor-not-allowed]="!canUnlockBoth()"
          class="w-full p-4 rounded-2xl bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 hover:border-purple-400 flex items-center gap-4 transition-all text-left relative overflow-hidden group">
             
           @if (canUnlockBoth()) {
             <div class="absolute top-0 right-0 bg-yellow-400 text-xs font-bold px-2 py-1 rounded-bl-lg">UNLOCKED</div>
           } @else {
             <div class="absolute top-0 right-0 bg-gray-300 text-xs font-bold px-2 py-1 rounded-bl-lg text-gray-600">LOCKED</div>
           }

           <div class="w-16 h-16 rounded-full bg-purple-200 flex items-center justify-center text-3xl shadow-inner">
              üë∂
            </div>
            <div class="w-full">
              <h3 class="font-bold text-purple-900 text-lg">Both!</h3>
              @if (!canUnlockBoth()) {
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2 max-w-[150px]">
                  <div class="bg-purple-600 h-2.5 rounded-full" [style.width.%]="(messageCount() / unlockThreshold) * 100"></div>
                </div>
                <p class="text-xs text-purple-600 mt-1">{{ messageCount() }}/{{ unlockThreshold }} messages to unlock</p>
              } @else {
                 <p class="text-sm text-purple-600">Sibling interaction mode.</p>
              }
            </div>
          </button>
      </div>
    </div>
  }

  <!-- Chat Stage -->
  @if (stage() === 'chat') {
    <div class="w-full max-w-md h-[80vh] bg-white rounded-3xl shadow-2xl flex flex-col overflow-hidden relative">
      
      <!-- Top Bar -->
      <div 
        [class.bg-indigo-500]="currentMood() === 'happy'"
        [class.bg-gray-500]="currentMood() === 'grumpy'"
        [class.bg-red-500]="currentMood() === 'tantrum'"
        class="p-4 flex items-center justify-between text-white shadow-md z-10 transition-colors duration-500">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">
             {{ getMoodEmoji() }}
          </div>
          <div>
            <h3 class="font-bold comic-font leading-none text-lg">
              {{ selectedChild() === 'Both' ? 'Siblings' : (selectedChild() === 'Billy' ? 'Biwwy' : 'Thawa') }}
            </h3>
            <p class="text-xs text-white/80 opacity-90 capitalize">{{ currentGame() ? 'Playing: ' + currentGame() : 'Mood: ' + currentMood() }}</p>
          </div>
        </div>
        <div class="flex gap-2">
             <!-- Games Button -->
            <button (click)="toggleGames()" 
              class="w-10 h-10 rounded-full bg-green-400 flex items-center justify-center transition-colors hover:bg-green-500 border border-green-300">
              <span class="text-lg">üéÆ</span>
            </button>
             <!-- Milestones Button -->
            <button (click)="toggleMilestones()" 
              class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center transition-colors hover:bg-indigo-300 border border-indigo-200">
              <span class="text-lg">üèÜ</span>
            </button>
            <!-- Shop Button -->
            <button (click)="toggleStore()" 
              class="w-10 h-10 rounded-full bg-orange-400 flex items-center justify-center transition-colors hover:bg-orange-500 border border-orange-300">
              <span class="text-lg">üõçÔ∏è</span>
            </button>
            <!-- Voice Button -->
            <button (click)="toggleVoice()" 
              [class.bg-green-400]="voiceEnabled()" 
              [class.bg-white/20]="!voiceEnabled()"
              class="w-10 h-10 rounded-full flex items-center justify-center transition-colors">
              <span class="text-lg">üîä</span>
            </button>
        </div>
      </div>

      <!-- Messages Area -->
      <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 hide-scrollbar" #chatContainer>
        
        @if (messages().length === 0) {
           <div class="text-center mt-10 opacity-50">
             <div class="text-6xl mb-4">üß∏</div>
             <p>Say hewo to start playing!</p>
           </div>
        }

        @for (msg of messages(); track $index) {
          @if (msg.role === 'user') {
            <!-- User Message -->
            <div class="flex justify-end animate-fade-in">
              <div class="bg-indigo-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-md">
                {{ msg.text }}
              </div>
            </div>
          } @else {
            <!-- Child Message -->
            <div class="flex flex-col items-start gap-2 animate-fade-in">
              <div class="flex items-end gap-2 max-w-[90%]">
                 <div class="w-8 h-8 rounded-full bg-indigo-100 flex-shrink-0 flex items-center justify-center text-sm border border-indigo-200">
                    üë∂
                 </div>
                 <div class="bg-white border-2 border-indigo-100 text-gray-800 px-5 py-3 rounded-2xl rounded-tl-none shadow-sm">
                   <p class="comic-font text-lg leading-snug whitespace-pre-wrap">{{ msg.text }}</p>
                 </div>
              </div>
              
              <!-- Generated Image -->
              @if (msg.image) {
                <div class="ml-10 rounded-2xl overflow-hidden shadow-lg border-4 border-white w-48 h-48 bg-gray-200 relative">
                  <img [src]="msg.image" class="w-full h-full object-cover" alt="Toddler activity">
                  <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] px-2 py-1 truncate">
                    {{ msg.activity }}
                  </div>
                </div>
              } @else {
                 <div class="ml-10 w-48 h-48 bg-gray-100 rounded-2xl flex items-center justify-center animate-pulse">
                   <span class="text-gray-400 text-xs">Drawing picture...</span>
                 </div>
              }
            </div>
          }
        }

        @if (isLoading()) {
          <div class="flex items-center gap-2 ml-10 text-gray-400 text-sm italic">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
            Thinking...
          </div>
        }
      </div>

      <!-- Input Area -->
      <div class="bg-white p-4 border-t border-gray-100 flex gap-2 items-center">
        <button (click)="startListening()" 
           [class.animate-pulse]="isListening()"
           [class.bg-red-500]="isListening()"
           [class.bg-gray-100]="!isListening()"
           class="w-12 h-12 rounded-full flex items-center justify-center text-xl transition-colors hover:bg-gray-200 flex-shrink-0">
           üé§
        </button>
        
        <input 
          #messageInput
          (keyup.enter)="sendMessage(messageInput.value); messageInput.value = ''"
          type="text" 
          placeholder="Talk to toddler..." 
          class="flex-1 bg-gray-100 rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all comic-font text-gray-700"
        >
        
        <button (click)="sendMessage(messageInput.value); messageInput.value = ''" 
          class="w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center transition-colors shadow-lg flex-shrink-0">
          ‚û§
        </button>
      </div>

    </div>
  }
</div>